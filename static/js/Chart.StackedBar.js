(function(){var c=this,b=c.Chart,d=b.helpers;var a={scaleBeginAtZero:true,scaleShowGridLines:true,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,barShowStroke:true,barStrokeWidth:2,barValueSpacing:5,relativeBars:false,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].fillColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'};b.Type.extend({name:"StackedBar",defaults:a,initialize:function(f){var e=this.options;this.ScaleClass=b.Scale.extend({offsetGridLines:true,calculateBarX:function(g){return this.calculateX(g)},calculateBarY:function(l,g,h,m){var n=0,k=0;for(var j=0;j<l.length;j++){k+=l[j].bars[h].value}for(j=g;j<l.length;j++){if(j===g&&m){n+=m}else{n+=l[j].bars[h].value}}if(e.relativeBars){n=n/k*100}return this.calculateY(n)},calculateBaseWidth:function(){return(this.calculateX(1)-this.calculateX(0))-(2*e.barValueSpacing)},calculateBaseHeight:function(){return(this.calculateY(1)-this.calculateY(0))},calculateBarWidth:function(g){return this.calculateBaseWidth()},calculateBarHeight:function(l,g,h,m){var k=0;for(var j=0;j<l.length;j++){k+=l[j].bars[h].value}if(!m){m=l[g].bars[h].value}if(e.relativeBars){m=m/k*100}return this.calculateY(m)}});this.datasets=[];if(this.options.showTooltips){d.bindEvents(this,this.options.tooltipEvents,function(g){var h=(g.type!=="mouseout")?this.getBarsAtEvent(g):[];this.eachBars(function(i){i.restore(["fillColor","strokeColor"])});d.each(h,function(i){i.fillColor=i.highlightFill;i.strokeColor=i.highlightStroke});this.showTooltip(h)})}this.BarClass=b.Rectangle.extend({strokeWidth:this.options.barStrokeWidth,showStroke:this.options.barShowStroke,ctx:this.chart.ctx});d.each(f.datasets,function(h,i){var g={label:h.label||null,fillColor:h.fillColor,strokeColor:h.strokeColor,bars:[]};this.datasets.push(g);d.each(h.data,function(j,k){if(d.isNumber(j)){g.bars.push(new this.BarClass({value:j,label:f.labels[k],datasetLabel:h.label,strokeColor:h.strokeColor,fillColor:h.fillColor,highlightFill:h.highlightFill||h.fillColor,highlightStroke:h.highlightStroke||h.strokeColor}))}},this)},this);this.buildScale(f.labels);this.eachBars(function(h,g,i){d.extend(h,{base:this.scale.endPoint,height:0,width:this.scale.calculateBarWidth(this.datasets.length),x:this.scale.calculateBarX(g),y:this.scale.endPoint});h.save()},this);this.render()},update:function(){this.scale.update();d.each(this.activeElements,function(e){e.restore(["fillColor","strokeColor"])});this.eachBars(function(e){e.save()});this.render()},eachBars:function(e){d.each(this.datasets,function(f,g){d.each(f.bars,e,this,g)},this)},getBarsAtEvent:function(j){var g=[],i=d.getRelativePosition(j),f=function(e){g.push(e.bars[h])},h;for(var k=0;k<this.datasets.length;k++){for(h=0;h<this.datasets[k].bars.length;h++){if(this.datasets[k].bars[h].inRange(i.x,i.y)){d.each(this.datasets,f);return g}}}return g},buildScale:function(h){var f=this;var g=function(){var i=[];d.each(f.datasets,function(j){d.each(j.bars,function(l,k){if(!i[k]){i[k]=0}if(f.options.relativeBars){i[k]=100}else{i[k]+=l.value}})});return i};var e={templateString:this.options.scaleLabel,height:this.chart.height,width:this.chart.width,ctx:this.chart.ctx,textColor:this.options.scaleFontColor,fontSize:this.options.scaleFontSize,fontStyle:this.options.scaleFontStyle,fontFamily:this.options.scaleFontFamily,valuesCount:h.length,beginAtZero:this.options.scaleBeginAtZero,integersOnly:this.options.scaleIntegersOnly,calculateYRange:function(j){var i=d.calculateScaleRange(g(),j,this.fontSize,this.beginAtZero,this.integersOnly);d.extend(this,i)},xLabels:h,font:d.fontString(this.options.scaleFontSize,this.options.scaleFontStyle,this.options.scaleFontFamily),lineWidth:this.options.scaleLineWidth,lineColor:this.options.scaleLineColor,gridLineWidth:(this.options.scaleShowGridLines)?this.options.scaleGridLineWidth:0,gridLineColor:(this.options.scaleShowGridLines)?this.options.scaleGridLineColor:"rgba(0,0,0,0)",padding:(this.options.showScale)?0:(this.options.barShowStroke)?this.options.barStrokeWidth:0,showLabels:this.options.scaleShowLabels,display:this.options.showScale};if(this.options.scaleOverride){d.extend(e,{calculateYRange:d.noop,steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+(this.options.scaleSteps*this.options.scaleStepWidth)})}this.scale=new this.ScaleClass(e)},addData:function(f,e){d.each(f,function(g,h){if(d.isNumber(g)){this.datasets[h].bars.push(new this.BarClass({value:g,label:e,x:this.scale.calculateBarX(this.scale.valuesCount+1),y:this.scale.endPoint,width:this.scale.calculateBarWidth(this.datasets.length),base:this.scale.endPoint,strokeColor:this.datasets[h].strokeColor,fillColor:this.datasets[h].fillColor}))}},this);this.scale.addXLabel(e);this.update()},removeData:function(){this.scale.removeXLabel();d.each(this.datasets,function(e){e.bars.shift()},this);this.update()},reflow:function(){d.extend(this.BarClass.prototype,{y:this.scale.endPoint,base:this.scale.endPoint});var e=d.extend({height:this.chart.height,width:this.chart.width});this.scale.update(e)},draw:function(g){var f=g||1;this.clear();var e=this.chart.ctx;this.scale.draw(f);d.each(this.datasets,function(h,i){d.each(h.bars,function(l,k){var m=this.scale.calculateBarY(this.datasets,i,k,l.value),j=this.scale.calculateBarHeight(this.datasets,i,k,l.value);l.transition({base:this.scale.endPoint-(Math.abs(j)-Math.abs(m)),x:this.scale.calculateBarX(k),y:Math.abs(m),height:Math.abs(j),width:this.scale.calculateBarWidth(this.datasets.length)},f).draw()},this)},this)}})}).call(this);